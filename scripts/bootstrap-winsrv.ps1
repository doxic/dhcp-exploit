# Networking -------------------------------------------------------------------
$DNSDomain="m123.local"
$DNSServerIP="8.8.8.8"
$DHCPServerIP="192.168.56.101"
$StartRange="192.168.56.100"
$EndRange="192.168.56.200"
$Subnet="255.255.255.0"
$Router="192.168.56.101"
$LeaseDuration = "1.00:00:00"

# ENV --------------------------------------------------------------------------
$KeyboadLanguage="DE-CH"

# Windows2016 ISO --------------------------------------------------------------
$localIso = "C:\\win2016.iso"
$url = "http://care.dlservice.microsoft.com/dl/download/1/6/F/16FA20E6-4662-482A-920B-1A45CF5AAE3C/14393.0.160715-1616.RS1_RELEASE_SERVER_EVAL_X64FRE_EN-US.ISO"
$url = "http://10.0.2.2/en_windows_server_2016_x64_dvd_9327751.iso"

# keyboard layout
Set-WinUserLanguageList -Force -LanguageList $KeyboadLanguage

# Download Win2016 iso
$wc = New-Object net.webclient
if (!(Test-Path $localIso)) { $wc.Downloadfile($url, $localIso) }
$mountVolume = Mount-DiskImage -ImagePath $localIso
$driveLetter = ($mountVolume | Get-Volume).DriveLetter

# Install DHCP Role
Install-WindowsFeature DHCP -IncludeManagementTools -Source "WIM:D:\\sources\\install.wim:4"

# Creating DHCP security groups
cmd.exe /c "netsh dhcp add securitygroups"

# restart the DHCP service for these groups to become active
Restart-service dhcpserver

# Authorizing the DHCP server in AD (only needed for a domain-joined setup)
# Add-DhcpServerInDC  <hostname of the DHCP server>  <IP address of the DHCP server>
#Add-DhcpServerInDC -DnsName $Env:COMPUTERNAME

# Server Manager may still raise a flag (alert) for its completion using the
# post-install configuration wizard. This alert can be suppressed by notifying
# the Server Manager that the post-install configuration has been completed
Set-ItemProperty -Path 'registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ServerManager\Roles\12' -Name "ConfigurationState" -Value 2

# Adds an IPv4 scope on the DHCP server service
Add-DhcpServerV4Scope -Name "DHCPScope" -StartRange $StartRange -EndRange $EndRange -SubnetMask $Subnet -LeaseDuration $LeaseDuration
#Set-DhcpServerv4Scope -ScopeId $DHCPServerIP -LeaseDuration
Get-DhcpServerv4Scope | Format-Table

# Sets an IPv4 option value at the server, scope, or reservation level.
Set-DhcpServerV4OptionValue -DnsDomain $DNSDomain -DnsServer $DNSServerIP -Router $Router
get-DhcpServerV4OptionValue | Format-Table
